# Instrucciones para Agentes de IA - Proyecto ERP Misionary

## âœ… **ESTADO ACTUAL: AUTENTICACIÃ“N COMPLETAMENTE FUNCIONAL**

### ğŸ‰ **LOGIN Y NAVEGACIÃ“N FUNCIONANDO CORRECTAMENTE**
- âœ… Sistema de login completamente operativo
- âœ… Usuario autenticado redirigido automÃ¡ticamente al layout principal
- âœ… Layout Elstar completo visible (header, sidebar, navegaciÃ³n)
- âœ… Rutas protegidas y pÃºblicas configuradas correctamente
- âœ… SincronizaciÃ³n AuthService â†” Redux â†” localStorage
- âœ… Sesiones persistentes entre recargas del navegador

### ğŸ”‘ **CREDENCIALES DE PRUEBA:**
- Email: admin@misionary.com
- Password: admin123

### ğŸš€ **PRÃ“XIMOS PASOS - DESARROLLO INCREMENTAL:**
**FASE 1: CRUD PRODUCTOS (SIGUIENTE)**
**FASE 2: CRUD PERSONAS**
**FASE 3: CRUD PRESUPUESTOS**
**FASE 4: CRUD FACTURAS**

---

## InformaciÃ³n General del Proyecto
- **Nombre**: Misionary ERP
- **Tipo**: Sistema ERP completo para empresa en crecimiento (10-100 empleados)
- **Stack**: Docker + Node.js/Express/Prisma/PostgreSQL (Backend) + React/Vite/Tailwind (Frontend)
- **Template Frontend**: Elstar React Template (https://elstar.themenate.net/app)

## Arquitectura del Proyecto

### Estructura de Directorios
```
misionary/
â”œâ”€â”€ docker-compose.yml          # OrquestaciÃ³n de contenedores
â”œâ”€â”€ .env                       # Variables de entorno principales
â”œâ”€â”€ backend/                   # API Node.js/Express
â”‚   â”œâ”€â”€ Dockerfile            # ConfiguraciÃ³n Docker backend
â”‚   â”œâ”€â”€ package.json          # Dependencias Node.js
â”‚   â”œâ”€â”€ .env                  # Variables de entorno backend
â”‚   â”œâ”€â”€ prisma/               # ORM y base de datos
â”‚   â”‚   â”œâ”€â”€ schema.prisma     # Esquema de base de datos
â”‚   â”‚   â”œâ”€â”€ seed.ts          # Datos iniciales
â”‚   â”‚   â””â”€â”€ migrations/       # Migraciones de BD
â”‚   â””â”€â”€ src/                  # CÃ³digo fuente
â”‚       â”œâ”€â”€ index.ts          # Punto de entrada
â”‚       â”œâ”€â”€ config/           # Configuraciones
â”‚       â”œâ”€â”€ controllers/      # Controladores API
â”‚       â”œâ”€â”€ services/         # LÃ³gica de negocio
â”‚       â”œâ”€â”€ middleware/       # Middlewares
â”‚       â””â”€â”€ routes/           # Rutas API
â””â”€â”€ frontend/                 # App React con Elstar Template
    â”œâ”€â”€ Dockerfile           # ConfiguraciÃ³n Docker frontend
    â”œâ”€â”€ package.json         # Dependencias React
    â””â”€â”€ src/                 # CÃ³digo fuente React
```

## ConfiguraciÃ³n del Entorno

### Variables de Entorno Principales (.env raÃ­z)
```
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
POSTGRES_DB=misionary
NODE_ENV=development
JWT_SECRET=your_super_secret_jwt_key_for_production
JWT_EXPIRES_IN=1d
VITE_API_URL=http://localhost:3001/api
CORS_ORIGIN=http://localhost:3000
```

### Puertos de Servicios
- **Frontend**: Puerto 3000 (http://localhost:3000) - Vite dev server
- **Backend API**: Puerto 3001 (http://localhost:3001/api)
- **PostgreSQL**: Puerto 5432 (localhost:5432)

## Comandos Esenciales

### Inicio Completo del Entorno
```bash
cd misionary/
docker-compose up -d
```

### Verificar Estado de Contenedores
```bash
docker ps -a
```

### Ver Logs de Servicios
```bash
docker logs misionary-backend-1
docker logs misionary-frontend-1
docker logs misionary-postgres-1
```

### Ejecutar Migraciones y Seed
```bash
# Desde el contenedor backend
docker exec misionary-backend-1 npm run db:migrate
docker exec misionary-backend-1 npm run db:seed
```

### Reconstruir Contenedores (cuando hay cambios)
```bash
docker-compose down
docker-compose build --no-cache
docker-compose up -d
```

## Dependencias Clave

### Backend (Node.js)
- **ORM**: Prisma 6.9.0
- **Framework**: Express 5.1.0
- **Auth**: bcrypt + jsonwebtoken
- **ValidaciÃ³n**: express-validator
- **Seguridad**: helmet, cors
- **Dev**: TypeScript, ts-node-dev (hot reload)

### Frontend (React)
- **Template**: Elstar React Template (comercial)
- **Build**: Vite
- **Styling**: Tailwind CSS
- **State**: Zustand/Redux (verificar template)
- **Routing**: React Router

## ConfiguraciÃ³n Especial del Template Elstar

### CaracterÃ­sticas del Template
- Dashboard administrativo completo
- Componentes UI preconstruidos
- Tema dark/light
- Responsive design
- MÃºltiples layouts
- Componentes de tablas, formularios, grÃ¡ficos

### IntegraciÃ³n con el ERP
- **AutenticaciÃ³n**: Adaptar el sistema de auth del template con nuestro JWT
- **Rutas**: Configurar rutas segÃºn roles (ADMIN, CONTADOR, PROVEEDOR)
- **API Integration**: Conectar componentes con nuestros endpoints
- **Temas**: Personalizar colores/branding para Misionary

## Estructura de la Base de Datos (Prisma Schema)

### Entidades Principales
1. **Persona**: Clientes, Proveedores, Internos
2. **Producto/Servicio**: Items para presupuestos
3. **Presupuesto**: Estados BORRADOR â†’ ENVIADO â†’ APROBADO â†’ FACTURADO
4. **Factura**: Estados EMITIDA / PAGADA / ANULADA
5. **Recibo**: Vinculado a facturas pagadas

### Usuario Admin por Defecto
- **Email**: admin@misionary.com
- **Password**: admin123
- **Rol**: ADMIN

## Estrategia de Desarrollo - IMPORTANTE

### âš ï¸ REGLA DE ORO: UN MÃ“DULO A LA VEZ
- **NUNCA** intentar implementar mÃºltiples CRUDs simultÃ¡neamente
- **SIEMPRE** completar un mÃ³dulo antes de pasar al siguiente
- **ENFOQUE**: ConfiguraciÃ³n â†’ AutenticaciÃ³n â†’ Un CRUD â†’ Siguiente CRUD

### Estado Actual del Proyecto
âœ… **COMPLETADO:**
- Docker environment funcionando
- Backend API operativo (puerto 3001)
- PostgreSQL con migraciones aplicadas
- AutenticaciÃ³n JWT funcional
- Usuario admin creado: admin@misionary.com / admin123
- Frontend Elstar funcionando (puerto 3000) - CON HOT RELOAD
- ConfiguraciÃ³n de puertos corregida (3000:5173)
- Error de autoprefixer corregido
- ConfiguraciÃ³n PostCSS/Tailwind corregida (@tailwindcss/postcss)
- Error de locale/idioma corregido (espaÃ±ol agregado)
- ConfiguraciÃ³n de rutas corregida (component vs element)
- ConexiÃ³n frontend-backend establecida (login funcional)
- SincronizaciÃ³n autenticaciÃ³n con Redux store del template
- ConfiguraciÃ³n de rutas de autenticaciÃ³n (/home)
- Frontend completamente funcional CON LAYOUT

âŒ **PENDIENTE (NO TOCAR HASTA COMPLETAR ANTERIOR):**
- CRUD Personas
- CRUD Productos
- CRUD Presupuestos
- Dashboard

## Patrones de Desarrollo

### API Endpoints
```
/api/auth/login    (POST) - AutenticaciÃ³n
/api/auth/register (POST) - Registro
/api/personas/*    (CRUD) - GestiÃ³n personas
/api/productos/*   (CRUD) - GestiÃ³n productos
/api/presupuestos/* (CRUD) - GestiÃ³n presupuestos
/api/facturas/*    (CRUD) - GestiÃ³n facturas
```

### Estructura de Controllers
- Usar clases estÃ¡ticas con mÃ©todos async
- Manejo de errores con try/catch
- ValidaciÃ³n con express-validator
- Respuestas JSON consistentes

### Middleware de AutenticaciÃ³n
- JWT en header Authorization: Bearer <token>
- Middleware `auth` para proteger rutas
- Middleware `checkRole` para autorizaciÃ³n por rol

## Troubleshooting ComÃºn

### Problemas de Contenedores
```bash
# Limpiar contenedores y volÃºmenes
docker-compose down -v
docker system prune -f

# Reconstruir desde cero
docker-compose build --no-cache
```

### Problemas de Base de Datos
```bash
# Reset completo de BD
docker-compose down -v
docker-compose up -d postgres
# Esperar que estÃ© healthy, luego:
docker exec misionary-backend-1 npx prisma migrate deploy
docker exec misionary-backend-1 npx prisma db seed
```

### Problemas de TypeScript
- Verificar que @types/* estÃ©n instalados
- Generar cliente Prisma: `npx prisma generate`
- Verificar imports (usar `bcrypt` no `bcryptjs`)

## Integraciones Futuras (No MVP)
- AFIP SDK para facturaciÃ³n electrÃ³nica
- Microservicio de emails
- Sistema de inventario
- Integraciones bancarias

## Notas Importantes para Agentes IA
1. **NUNCA** cambiar configuraciones de Docker sin consultar
2. **SIEMPRE** usar `bcrypt` en lugar de `bcryptjs`
3. **VERIFICAR** que el template Elstar estÃ© correctamente configurado
4. **RESPETAR** la estructura de roles y permisos establecida
5. **USAR** los endpoints existentes antes de crear nuevos
6. **DOCUMENTAR** cualquier cambio importante en este archivo

## Contacto y Referencias
- Template Elstar: https://elstar.themenate.net/app
- DocumentaciÃ³n Prisma: https://www.prisma.io/docs
- DocumentaciÃ³n Express: https://expressjs.com/
- DocumentaciÃ³n Docker Compose: https://docs.docker.com/compose/

---

## âœ… **ESTADO ACTUAL COMPLETADO (Enero 2025)**

### ğŸ¯ **AUTENTICACIÃ“N Y NAVEGACIÃ“N - 100% FUNCIONAL**

#### Backend API:
- âœ… Servidor Express corriendo en puerto 3001
- âœ… PostgreSQL 16 con datos de prueba
- âœ… Endpoint `/api/auth/login` funcionando correctamente
- âœ… JWT tokens generados y validados
- âœ… Usuario admin creado: admin@misionary.com / admin123

#### Frontend React:
- âœ… AplicaciÃ³n corriendo en puerto 3000
- âœ… Template Elstar completamente integrado
- âœ… Sistema de rutas protegidas/pÃºblicas
- âœ… Hook useAuth sincronizado con Redux
- âœ… AuthService manejando localStorage
- âœ… Login funcional con redirecciÃ³n automÃ¡tica
- âœ… Layout principal visible post-autenticaciÃ³n

#### Flujo de AutenticaciÃ³n:
1. Usuario accede a `/login`
2. Ingresa credenciales (admin@misionary.com / admin123)
3. AuthService envÃ­a POST `/api/auth/login`
4. Backend responde con { user, token }
5. Frontend almacena en localStorage + Redux
6. Usuario es redirigido a `/home` (layout principal)
7. Layout Elstar se muestra con header, sidebar, navegaciÃ³n

### ğŸš€ **PRÃ“XIMA FASE: DESARROLLO INCREMENTAL DE CRUDS**

#### **âœ… FASE COMPLETADA: CRUD PERSONAS - EJEMPLO DE IMPLEMENTACIÃ“N EXITOSA**

**ğŸ‰ ESTADO: 100% FUNCIONAL - CREAR, LISTAR, EDITAR, ELIMINAR**

**ARQUITECTURA HÃBRIDA IMPLEMENTADA:**
Hemos establecido una arquitectura que separa claramente la lÃ³gica de negocio de la lÃ³gica de UI:

```
frontend/src/
â”œâ”€â”€ modules/                           # LÃ“GICA DE NEGOCIO
â”‚   â””â”€â”€ persona/
â”‚       â”œâ”€â”€ types.ts                   # Tipos de dominio (Persona, DTOs)
â”‚       â”œâ”€â”€ service.ts                 # Llamadas a API (usando ApiService.fetchData)
â”‚       â””â”€â”€ hooks/
â”‚           â””â”€â”€ usePersona.ts          # Hook principal con lÃ³gica de negocio
â”œâ”€â”€ views/                             # LÃ“GICA DE UI
â”‚   â””â”€â”€ personas/
â”‚       â”œâ”€â”€ types.ts                   # Re-exports + tipos especÃ­ficos de UI
â”‚       â”œâ”€â”€ schemas.ts                 # ValidaciÃ³n Zod + enums locales
â”‚       â”œâ”€â”€ hooks/
â”‚       â”‚   â””â”€â”€ index.ts               # Hooks especÃ­ficos de UI (filtros, etc.)
â”‚       â”œâ”€â”€ PersonaList/
â”‚       â”‚   â”œâ”€â”€ index.tsx              # Export limpio
â”‚       â”‚   â””â”€â”€ PersonaList.tsx        # Componente principal con DataTable
â”‚       â”œâ”€â”€ PersonaForm/
â”‚       â”‚   â”œâ”€â”€ index.tsx              # Export limpio
â”‚       â”‚   â””â”€â”€ PersonaForm.tsx        # Formulario base reutilizable
â”‚       â”œâ”€â”€ PersonaNew/
â”‚       â”‚   â”œâ”€â”€ index.tsx              # Export limpio
â”‚       â”‚   â””â”€â”€ PersonaNew.tsx         # PÃ¡gina de alta con React Hook Form + Zod
â”‚       â”œâ”€â”€ PersonaEdit/
â”‚       â”‚   â”œâ”€â”€ index.tsx              # Export limpio
â”‚       â”‚   â””â”€â”€ PersonaEdit.tsx        # PÃ¡gina de ediciÃ³n con React Hook Form + Zod
â”‚       â””â”€â”€ index.tsx                  # Vista principal que orquesta todo
```

**TECNOLOGÃAS INTEGRADAS Y FUNCIONANDO:**
- âœ… **Framer Motion**: Animaciones y microinteracciones en todas las vistas
- âœ… **React Hook Form**: GestiÃ³n de formularios en PersonaNew y PersonaEdit
- âœ… **Zod**: ValidaciÃ³n de esquemas con enums locales
- âœ… **DataTable**: Listado con filtros, paginaciÃ³n, ordenamiento
- âœ… **Componentes UI**: Badge, Tag, Tooltip, Button, Dialog, Alert integrados

**FUNCIONALIDADES 100% OPERATIVAS:**
1. **âœ… CREAR**: `/personas/new` - Formulario completo con validaciÃ³n
2. **âœ… LISTAR**: `/personas` - DataTable con columnas ID, Nombre, Email, Tipo, Roles, Acciones
3. **âœ… EDITAR**: `/personas/edit/:id` - Formulario pre-poblado con validaciÃ³n
4. **âœ… ELIMINAR**: ConfirmaciÃ³n con ConfirmDialog antes de eliminar
5. **âœ… NAVEGACIÃ“N**: IntegraciÃ³n completa con sidebar del template
6. **âœ… ROLES MÃšLTIPLES**: VisualizaciÃ³n correcta con Tags de colores Ãºnicos
7. **âœ… VALIDACIÃ“N**: Esquemas Zod funcionando en tiempo real
8. **âœ… ANIMACIONES**: Microinteracciones suaves con Framer Motion

**PROBLEMAS RESUELTOS EXITOSAMENTE:**
1. **âŒâ†’âœ… @prisma/client**: Eliminado del frontend, creados enums locales
2. **âŒâ†’âœ… Loop infinito**: Corregidas dependencias de useEffect
3. **âŒâ†’âœ… Keys duplicadas**: Agregados Ã­ndices Ãºnicos en mapeo de roles
4. **âŒâ†’âœ… Formularios**: React Hook Form + Zod implementado correctamente
5. **âŒâ†’âœ… NavegaciÃ³n**: Rutas de ediciÃ³n funcionando perfectamente
6. **âŒâ†’âœ… ActualizaciÃ³n**: Backend y frontend sincronizados

#### **ğŸ¯ SIGUIENTE FASE: CRUD PRODUCTOS (USAR PERSONAS COMO PLANTILLA PERFECTA)**

**PASO A PASO PARA REPLICAR EL Ã‰XITO:**

**1. CREAR ESTRUCTURA DE ARCHIVOS (OBLIGATORIA):**
```bash
mkdir -p frontend/src/views/productos/{ProductoList,ProductoForm,ProductoNew,ProductoEdit,hooks}
```

```
views/productos/
â”œâ”€â”€ schemas.ts                    # CRÃTICO: Enums locales + validaciÃ³n Zod
â”œâ”€â”€ types.ts                      # Re-exports desde modules/
â”œâ”€â”€ hooks/index.ts                # Hooks UI especÃ­ficos
â”œâ”€â”€ ProductoList/
â”‚   â”œâ”€â”€ index.tsx                # export { default } from './ProductoList';
â”‚   â””â”€â”€ ProductoList.tsx         # DataTable + columnas + acciones
â”œâ”€â”€ ProductoForm/
â”‚   â”œâ”€â”€ index.tsx                # export { default } from './ProductoForm';
â”‚   â””â”€â”€ ProductoForm.tsx         # Formulario base reutilizable
â”œâ”€â”€ ProductoNew/
â”‚   â”œâ”€â”€ index.tsx                # export { default } from './ProductoNew';
â”‚   â””â”€â”€ ProductoNew.tsx          # React Hook Form + Zod + animaciones
â”œâ”€â”€ ProductoEdit/
â”‚   â”œâ”€â”€ index.tsx                # export { default } from './ProductoEdit';
â”‚   â””â”€â”€ ProductoEdit.tsx         # React Hook Form + Zod + animaciones
â””â”€â”€ index.tsx                    # Vista principal orquestadora
```

**2. CONFIGURAR VALIDACIÃ“N ZOD (COPIAR DE PERSONAS):**
```typescript
// views/productos/schemas.ts
import { z } from 'zod';

// CRÃTICO: Enums locales (NO @prisma/client)
export enum TipoProducto {
  PRODUCTO = 'PRODUCTO',
  SERVICIO = 'SERVICIO'
}

export enum EstadoProducto {
  ACTIVO = 'ACTIVO',
  INACTIVO = 'INACTIVO'
}

export const productoSchema = z.object({
  nombre: z.string().min(2, 'MÃ­nimo 2 caracteres'),
  descripcion: z.string().optional(),
  precio: z.number().positive('Debe ser positivo'),
  tipo: z.nativeEnum(TipoProducto),
  estado: z.nativeEnum(EstadoProducto)
});

export const createProductoSchema = productoSchema;
export const updateProductoSchema = productoSchema.partial();

export type CreateProductoFormData = z.infer<typeof createProductoSchema>;
export type UpdateProductoFormData = z.infer<typeof updateProductoSchema>;
```

**3. ACTUALIZAR LÃ“GICA DE NEGOCIO:**
```typescript
// modules/producto/service.ts - USAR PATRÃ“N FETCHDATA
export async function fetchProductos(): Promise<Producto[]> {
  const response = await ApiService.fetchData<Producto[]>({ 
    url: '/productos', 
    method: 'GET' 
  });
  return response.data;
}

export async function createProducto(data: CreateProductoDTO): Promise<Producto> {
  const response = await ApiService.fetchData<Producto>({ 
    url: '/productos', 
    method: 'POST', 
    data 
  });
  return response.data;
}
// ... mÃ¡s mÃ©todos igual que personas
```

**4. CONFIGURAR NAVEGACIÃ“N (COPIAR PATRÃ“N PERSONAS):**
```typescript
// configs/routes.config.tsx
const ProductoView = lazy(() => import('@/views/productos'));
const ProductoNew = lazy(() => import('@/views/productos/ProductoNew'));
const ProductoEdit = lazy(() => import('@/views/productos/ProductoEdit'));

// Agregar rutas:
{ key: 'productos', path: '/productos', component: ProductoView },
{ key: 'producto-new', path: '/productos/new', component: ProductoNew },
{ key: 'producto-edit', path: '/productos/edit/:id', component: ProductoEdit },
```

**5. CREAR COMPONENTES (COPIAR ESTRUCTURA DE PERSONAS):**
- **ProductoList.tsx**: DataTable con columnas especÃ­ficas
- **ProductoNew.tsx**: React Hook Form + Zod + Framer Motion
- **ProductoEdit.tsx**: Igual que PersonaEdit pero para productos
- **hooks/useProducto.ts**: Hook principal con CRUD operations

**PUNTOS CRÃTICOS PARA NO FALLAR:**
1. **âŒ NUNCA** importar de `@prisma/client` en frontend
2. **âœ… SIEMPRE** crear enums locales en `schemas.ts`
3. **âœ… USAR** `ApiService.fetchData({ url, method, data })`
4. **âœ… MANTENER** estructura modules/ + views/
5. **âœ… AGREGAR** rutas en routes.config.tsx
6. **âœ… CONFIGURAR** navegaciÃ³n en navigation.config/
7. **âœ… AGREGAR** traducciones en locales/lang/es.json

#### **ğŸ”§ COMANDOS DESARROLLO:**
```bash
# Instalar nuevas dependencias
./manage.sh frontend npm install

# Iniciar desarrollo frontend
./manage.sh frontend npm run dev

# Ver errores en tiempo real
docker-compose logs -f frontend
```

### ğŸ”§ **COMANDOS ÃšTILES**
```bash
# Iniciar entorno completo
docker-compose up -d

# Ver logs
docker-compose logs -f frontend
docker-compose logs -f backend

# Reiniciar servicios
docker-compose restart frontend
docker-compose restart backend

# Acceder a base de datos
docker exec -it misionary-postgres-1 psql -U postgres -d misionary
```

### ğŸ“‹ **VERIFICACIONES DIARIAS**
- [ ] Contenedores corriendo: `docker ps`
- [ ] Backend responde: `curl http://localhost:3001/api/health`
- [ ] Frontend carga: `http://localhost:3000`
- [ ] Login funciona: admin@misionary.com / admin123
- [ ] Layout principal visible post-login

---

**ğŸ‰ ENTORNO COMPLETAMENTE FUNCIONAL - READY FOR DEVELOPMENT! ğŸ‰**
