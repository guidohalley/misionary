generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Moneda {
  id                 Int               @id @default(autoincrement())
  codigo             CodigoMoneda      @unique
  nombre             String
  simbolo            String
  activo             Boolean           @default(true)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  facturas           Factura[]
  gastosOperativos   GastoOperativo[]
  historialPrecios   HistorialPrecio[] @relation("HistorialPrecioMoneda")
  presupuestos       Presupuesto[]
  productos          Producto[]
  servicios          Servicio[]
  recibos            Recibo[]
  pagosAdmin         PagoAdmin[]
  cobrosCliente      CobroCliente[]
  tiposCambio        TipoCambio[]      @relation("MonedaOrigen")
  tiposCambioDestino TipoCambio[]      @relation("MonedaDestino")
}

model CobroCliente {
  id            Int         @id @default(autoincrement())
  presupuestoId Int
  monto         Decimal     @db.Decimal(15, 2)
  monedaId      Int         @default(1)
  fecha         DateTime
  metodoPago    String
  concepto      String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  presupuesto   Presupuesto @relation(fields: [presupuestoId], references: [id])
  moneda        Moneda      @relation(fields: [monedaId], references: [id])

  @@index([presupuestoId])
  @@index([fecha])
}

model TipoCambio {
  id            Int      @id @default(autoincrement())
  monedaDesdeId Int
  monedaHaciaId Int
  valor         Decimal  @db.Decimal(15, 4)
  fecha         DateTime @db.Date
  createdAt     DateTime @default(now())
  monedaDesde   Moneda   @relation("MonedaOrigen", fields: [monedaDesdeId], references: [id])
  monedaHacia   Moneda   @relation("MonedaDestino", fields: [monedaHaciaId], references: [id])

  @@unique([monedaDesdeId, monedaHaciaId, fecha])
}

model Persona {
  id                      Int               @id @default(autoincrement())
  nombre                  String
  tipo                    TipoPersona
  telefono                String?
  cvu                     String?
  roles                   RolUsuario[]
  password                String?
  email                   String            @unique
  createdAt               DateTime          @default(now())
  updatedAt               DateTime          @updatedAt
  activo                  Boolean           @default(true)
  esUsuario               Boolean           @default(false)
  gastosComoProveedor     GastoOperativo[]  @relation("GastoProveedor")
  historialPreciosUsuario HistorialPrecio[] @relation("HistorialPrecioUsuario")
  presupuestos            Presupuesto[]     @relation("ClientePresupuestos")
  productos               Producto[]
  recibos                 Recibo[]
  pagosAdmin              PagoAdmin[]
  servicios               Servicio[]
  empresas                Empresa[]         @relation("ClienteEmpresas")
}

model Empresa {
  id          Int       @id @default(autoincrement())
  nombre      String
  razonSocial String?
  cuit        String?   @unique
  telefono    String?
  email       String?
  direccion   String?
  clienteId   Int
  activo      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relaciones
  cliente     Persona   @relation("ClienteEmpresas", fields: [clienteId], references: [id], onDelete: Cascade)
  presupuestos Presupuesto[] @relation("EmpresaPresupuestos")
  facturas    Factura[] @relation("EmpresaFacturas")

  @@index([clienteId])
  @@index([activo])
}

model Producto {
  id               Int               @id @default(autoincrement())
  nombre           String
  costoProveedor   Decimal           @db.Decimal(15, 2)
  margenAgencia    Decimal           @db.Decimal(5, 2)
  precio           Decimal           @db.Decimal(15, 2)
  proveedorId      Int
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  monedaId         Int               @default(1)
  historialPrecios HistorialPrecio[] @relation("ProductoHistorialPrecios")
  items            Item[]
  moneda           Moneda            @relation(fields: [monedaId], references: [id])
  proveedor        Persona           @relation(fields: [proveedorId], references: [id])
}

model Servicio {
  id               Int               @id @default(autoincrement())
  nombre           String
  descripcion      String
  costoProveedor   Decimal           @db.Decimal(15, 2)
  margenAgencia    Decimal           @db.Decimal(5, 2)
  precio           Decimal           @db.Decimal(15, 2)
  proveedorId      Int
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  monedaId         Int               @default(1)
  historialPrecios HistorialPrecio[] @relation("ServicioHistorialPrecios")
  items            Item[]
  moneda           Moneda            @relation(fields: [monedaId], references: [id])
  proveedor        Persona           @relation(fields: [proveedorId], references: [id])
}

model Presupuesto {
  id                   Int                       @id @default(autoincrement())
  clienteId            Int
  empresaId            Int?
  subtotal             Decimal                   @db.Decimal(15, 2)
  impuestos            Decimal                   @db.Decimal(15, 2)
  total                Decimal                   @db.Decimal(15, 2)
  estado               EstadoPresupuesto         @default(BORRADOR)
  createdAt            DateTime                  @default(now())
  updatedAt            DateTime                  @updatedAt
  monedaId             Int                       @default(1)
  tipoCambioFecha      DateTime?
  // Periodo y recurrencia
  periodoInicio        DateTime?
  periodoFin           DateTime?
  esRecurrente         Boolean                   @default(false)
  frecuencia           FrecuenciaContrato?
  renovacionAutomatica Boolean                   @default(false)
  precioPeriodo        Decimal?                  @db.Decimal(15, 2)
  asignacionesGasto    AsignacionGastoProyecto[]
  facturas             Factura[]
  items                Item[]
  cliente              Persona                   @relation("ClientePresupuestos", fields: [clienteId], references: [id])
  empresa              Empresa?                  @relation("EmpresaPresupuestos", fields: [empresaId], references: [id])
  moneda               Moneda                    @relation(fields: [monedaId], references: [id])
  presupuestoImpuestos PresupuestoImpuesto[]
  recibos              Recibo[]
  pagosAdmin           PagoAdmin[]
  // Relaci√≥n a cobros directos de cliente (sin factura)
  cobrosCliente        CobroCliente[]
}

model Item {
  id             Int         @id @default(autoincrement())
  presupuestoId  Int
  productoId     Int?
  servicioId     Int?
  cantidad       Int
  precioUnitario Decimal     @db.Decimal(15, 2)
  presupuesto    Presupuesto @relation(fields: [presupuestoId], references: [id])
  producto       Producto?   @relation(fields: [productoId], references: [id])
  servicio       Servicio?   @relation(fields: [servicioId], references: [id])
}

model Factura {
  id                 Int           @id @default(autoincrement())
  numero             String        @unique
  presupuestoId      Int
  empresaId          Int?
  fecha              DateTime
  subtotal           Decimal       @db.Decimal(15, 2)
  impuestos          Decimal       @db.Decimal(15, 2)
  total              Decimal       @db.Decimal(15, 2)
  estado             EstadoFactura
  impuestoAplicadoId Int
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  monedaId           Int           @default(1)
  tipoCambioFecha    DateTime?
  empresa            Empresa?      @relation("EmpresaFacturas", fields: [empresaId], references: [id])
  impuestoAplicado   Impuesto      @relation(fields: [impuestoAplicadoId], references: [id])
  moneda             Moneda        @relation(fields: [monedaId], references: [id])
  presupuesto        Presupuesto   @relation(fields: [presupuestoId], references: [id])
}

model Recibo {
  id         Int      @id @default(autoincrement())
  personaId  Int
  presupuestoId Int?
  concepto   String
  monto      Decimal  @db.Decimal(15, 2)
  fecha      DateTime
  metodoPago String
  tipo       ReciboTipo @default(PROVEEDOR)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  persona    Persona  @relation(fields: [personaId], references: [id])
  presupuesto Presupuesto? @relation(fields: [presupuestoId], references: [id])
  monedaId   Int      @default(1)
  moneda     Moneda   @relation(fields: [monedaId], references: [id])
}

model Impuesto {
  id                   Int                   @id @default(autoincrement())
  nombre               String                @unique
  porcentaje           Decimal               @db.Decimal(5, 2)
  activo               Boolean               @default(true)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  descripcion          String?
  facturas             Factura[]
  presupuestoImpuestos PresupuestoImpuesto[]
}

model PresupuestoImpuesto {
  id            Int         @id @default(autoincrement())
  presupuestoId Int
  impuestoId    Int
  monto         Decimal     @db.Decimal(15, 2)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  impuesto      Impuesto    @relation(fields: [impuestoId], references: [id])
  presupuesto   Presupuesto @relation(fields: [presupuestoId], references: [id])

  @@unique([presupuestoId, impuestoId])
}

model GastoOperativo {
  id            Int                       @id @default(autoincrement())
  concepto      String
  descripcion   String?
  monto         Decimal                   @db.Decimal(15, 2)
  monedaId      Int
  fecha         DateTime
  categoria     CategoriaGasto
  esRecurrente  Boolean                   @default(false)
  frecuencia    String?
  proveedorId   Int?
  comprobante   String?
  observaciones String?
  activo        Boolean                   @default(true)
  createdAt     DateTime                  @default(now())
  updatedAt     DateTime                  @updatedAt
  asignaciones  AsignacionGastoProyecto[]
  moneda        Moneda                    @relation(fields: [monedaId], references: [id])
  proveedor     Persona?                  @relation("GastoProveedor", fields: [proveedorId], references: [id])
}

model AsignacionGastoProyecto {
  id            Int            @id @default(autoincrement())
  gastoId       Int
  presupuestoId Int
  porcentaje    Decimal        @db.Decimal(5, 2)
  montoAsignado Decimal        @db.Decimal(15, 2)
  justificacion String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  gasto         GastoOperativo @relation(fields: [gastoId], references: [id], onDelete: Cascade)
  presupuesto   Presupuesto    @relation(fields: [presupuestoId], references: [id], onDelete: Cascade)

  @@unique([gastoId, presupuestoId])
}

model HistorialPrecio {
  id           Int       @id @default(autoincrement())
  productoId   Int?
  servicioId   Int?
  monedaId     Int
  precio       Decimal   @db.Decimal(15, 2)
  fechaDesde   DateTime
  fechaHasta   DateTime?
  motivoCambio String?
  usuarioId    Int?
  activo       Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  moneda       Moneda    @relation("HistorialPrecioMoneda", fields: [monedaId], references: [id])
  producto     Producto? @relation("ProductoHistorialPrecios", fields: [productoId], references: [id], onDelete: Cascade)
  servicio     Servicio? @relation("ServicioHistorialPrecios", fields: [servicioId], references: [id], onDelete: Cascade)
  usuario      Persona?  @relation("HistorialPrecioUsuario", fields: [usuarioId], references: [id])

  @@index([productoId, activo])
  @@index([servicioId, activo])
  @@index([fechaDesde])
}

model PagoAdmin {
  id            Int         @id @default(autoincrement())
  adminId       Int
  presupuestoId Int
  monto         Decimal     @db.Decimal(15, 2)
  monedaId      Int         @default(1)
  fecha         DateTime
  metodoPago    String
  concepto      String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  admin         Persona     @relation(fields: [adminId], references: [id])
  presupuesto   Presupuesto @relation(fields: [presupuestoId], references: [id])
  moneda        Moneda      @relation(fields: [monedaId], references: [id])

  @@index([presupuestoId])
}

enum TipoPersona {
  CLIENTE
  PROVEEDOR
  INTERNO
}

enum RolUsuario {
  ADMIN
  CONTADOR
  PROVEEDOR
}

enum EstadoPresupuesto {
  BORRADOR
  ENVIADO
  APROBADO
  FACTURADO
}

enum EstadoFactura {
  EMITIDA
  PAGADA
  ANULADA
}

enum CodigoMoneda {
  ARS
  USD
  EUR
}

enum CategoriaGasto {
  OFICINA
  PERSONAL
  MARKETING
  TECNOLOGIA
  SERVICIOS
  TRANSPORTE
  COMUNICACION
  OTROS
}

enum ReciboTipo {
  PROVEEDOR
  ADMIN
}

enum FrecuenciaContrato {
  UNICO
  MENSUAL
  TRIMESTRAL
  ANUAL
}
